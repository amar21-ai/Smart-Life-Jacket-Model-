<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Life Jacket – AI Rescue Dashboard</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
        color: #ffffff;
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1800px;
        margin: 0 auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      }

      h1 {
        font-size: 28px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 5px;
      }

      .subtitle {
        color: #8b92b0;
        font-size: 14px;
      }

      .controls {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      select {
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-weight: 600;
        cursor: pointer;
        outline: none;
        font-size: 14px;
      }

      select option {
        background: #1a1f3a;
        color: white;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-bottom: 15px;
      }

      .stat-icon.users {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .stat-icon.high {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .stat-icon.eta {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      .stat-label {
        color: #8b92b0;
        font-size: 14px;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: white;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .card-title {
        font-size: 20px;
        font-weight: 700;
      }

      #map {
        height: 600px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .marker-high {
        width: 20px;
        height: 20px;
        background: #ff3b5c;
        border: 3px solid #fff;
        border-radius: 50%;
        box-shadow: 0 0 20px rgba(255, 59, 92, 0.8);
        animation: pulse 2s infinite;
      }

      .marker-medium {
        width: 18px;
        height: 18px;
        background: #ffa726;
        border: 3px solid #fff;
        border-radius: 50%;
        box-shadow: 0 0 15px rgba(255, 167, 38, 0.6);
      }

      .marker-low {
        width: 16px;
        height: 16px;
        background: #66bb6a;
        border: 3px solid #fff;
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(102, 187, 106, 0.4);
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 20px rgba(255, 59, 92, 0.8);
        }
        50% {
          box-shadow: 0 0 40px rgba(255, 59, 92, 1);
        }
        100% {
          box-shadow: 0 0 20px rgba(255, 59, 92, 0.8);
        }
      }

      .table-container {
        max-height: 600px;
        overflow-y: auto;
        border-radius: 15px;
      }

      .table-container::-webkit-scrollbar {
        width: 8px;
      }

      .table-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .table-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #8b92b0;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 14px;
      }

      tr:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .priority-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
      }

      .priority-high {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
      }

      .priority-medium {
        background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
        color: white;
      }

      .priority-low {
        background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
        color: white;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        animation: blink 2s infinite;
      }

      .status-online {
        background: #66bb6a;
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading {
        display: none;
        margin-left: 10px;
      }

      .status-bar {
        margin-top: 20px;
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-text {
        color: #8b92b0;
        font-size: 14px;
      }

      @media (max-width: 1200px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          gap: 20px;
        }

        .controls {
          width: 100%;
          justify-content: center;
        }

        #map {
          height: 400px;
        }
      }

      .path-label {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="brand">
          <div class="logo">
            <i class="fas fa-life-ring"></i>
          </div>
          <div>
            <h1>Smart Life Jacket – AI Rescue Dashboard</h1>
            <p class="subtitle">
              <span class="status-indicator status-online"></span>Real-time
              Monitoring & Priority System
            </p>
          </div>
        </div>
        <div class="controls">
          <button id="btn-load-users" class="btn btn-primary">
            <i class="fas fa-users"></i>
            Load Users
            <div class="spinner loading" id="loading-users"></div>
          </button>
          <select id="victim-count">
            <option value="5">Top 5 Priority</option>
            <option value="10">Top 10 Priority</option>
            <option value="15">Top 15 Priority</option>
            <option value="20">Top 20 Priority</option>
          </select>
          <button id="btn-draw-paths" class="btn btn-success">
            <i class="fas fa-route"></i>
            Draw Rescue Paths
          </button>
          <button id="btn-clear" class="btn btn-secondary">
            <i class="fas fa-times"></i>
            Clear All
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon users">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-label">Total Users in Sea</div>
          <div class="stat-value" id="total-users">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon high">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="stat-label">High Priority Cases</div>
          <div class="stat-value" id="high-priority">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon eta">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-label">Average ETA</div>
          <div class="stat-value" id="avg-eta">0 min</div>
        </div>
      </div>

      <div class="main-grid">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-map-marked-alt"></i>
              Live Rescue Map
            </h3>
          </div>
          <div id="map"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-list"></i>
              Victims Data
            </h3>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Priority</th>
                  <th>HR</th>
                  <th>SpO₂</th>
                  <th>State</th>
                  <th>ETA</th>
                </tr>
              </thead>
              <tbody id="victims-tbody">
                <tr>
                  <td
                    colspan="6"
                    style="text-align: center; color: #8b92b0; padding: 40px"
                  >
                    <i
                      class="fas fa-info-circle"
                      style="
                        font-size: 32px;
                        margin-bottom: 10px;
                        display: block;
                      "
                    ></i>
                    No users loaded. Click "Load Users" to start.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="status-bar">
        <i class="fas fa-info-circle"></i>
        <span class="status-text" id="status-text">Ready to load users</span>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      const API_URL = "http://127.0.0.1:5000/predict";
      const RESCUE_CENTER = { lat: 31.2, lon: 29.9 };
      const BOAT_SPEED_KMH = 30;

      const map = L.map("map").setView(
        [RESCUE_CENTER.lat, RESCUE_CENTER.lon],
        9
      );

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
        maxZoom: 18,
      }).addTo(map);

      const rescueCenterIcon = L.divIcon({
        className: "rescue-center-icon",
        html: `
                <div style="
                    width: 30px;
                    height: 30px;
                    background: white;
                    border: 4px solid #667eea;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 0 20px rgba(102, 126, 234, 0.6);
                ">
                    <i class="fas fa-anchor" style="color: #667eea; font-size: 14px;"></i>
                </div>
            `,
        iconSize: [30, 30],
        iconAnchor: [15, 15],
      });

      L.marker([RESCUE_CENTER.lat, RESCUE_CENTER.lon], {
        icon: rescueCenterIcon,
      })
        .addTo(map)
        .bindPopup("<b>Rescue Center</b><br>Alexandria Port");

      let markers = {};
      let rescuePaths = [];
      let victimsData = [];

      function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function calculateETA(distanceKm) {
        return Math.round((distanceKm / BOAT_SPEED_KMH) * 60);
      }

      function createMarker(victim) {
        // Default to low priority if not set
        const priority = victim.priority_class || "Low";
        let markerClass = "marker-low";

        if (priority === "High") markerClass = "marker-high";
        else if (priority === "Medium") markerClass = "marker-medium";

        const icon = L.divIcon({
          className: "",
          html: `<div class="${markerClass}"></div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12],
        });

        return L.marker([victim.lat, victim.lon], { icon }).bindPopup(`
          <div style="font-family: Inter, sans-serif;">
              <strong style="font-size: 14px;">${victim.id}</strong><br>
              <span style="color: #666;">Priority Score:</span> <strong>${
                victim.priority_score || "N/A"
              }</strong><br>
              <span style="color: #666;">Classification:</span> <strong>${priority}</strong><br>
              <span style="color: #666;">Heart Rate:</span> ${
                victim.heart_rate
              } bpm<br>
              <span style="color: #666;">SpO₂:</span> ${victim.spo2}%<br>
              <span style="color: #666;">State:</span> ${
                victim.state === 1 ? "Sinking" : "Floating"
              }<br>
              <span style="color: #666;">ETA:</span> ${victim.eta_min} min
          </div>
        `);
      }

      function updateStats() {
        document.getElementById("total-users").textContent = victimsData.length;

        const highPriority = victimsData.filter(
          (v) => v.priority_class === "High"
        ).length;
        document.getElementById("high-priority").textContent = highPriority;

        if (victimsData.length > 0) {
          const avgEta = Math.round(
            victimsData.reduce((sum, v) => sum + v.eta_min, 0) /
              victimsData.length
          );
          document.getElementById("avg-eta").textContent = `${avgEta} min`;
        } else {
          document.getElementById("avg-eta").textContent = "0 min";
        }
      }

      function updateTable() {
        const tbody = document.getElementById("victims-tbody");
        tbody.innerHTML = "";

        const sortedVictims = [...victimsData].sort(
          (a, b) => b.priority_score - a.priority_score
        );

        sortedVictims.forEach((victim) => {
          const row = document.createElement("tr");

          let priorityClass = "priority-low";
          if (victim.priority_class === "High") priorityClass = "priority-high";
          else if (victim.priority_class === "Medium")
            priorityClass = "priority-medium";

          row.innerHTML = `
                    <td>${victim.id}</td>
                    <td><span class="priority-badge ${priorityClass}">${
            victim.priority_class
          }</span></td>
                    <td>${victim.heart_rate} bpm</td>
                    <td>${victim.spo2}%</td>
                    <td>${victim.state === 1 ? "Sinking" : "Floating"}</td>
                    <td>${victim.eta_min} min</td>
                `;

          tbody.appendChild(row);
        });
      }

      function setStatus(message, isError = false) {
        const statusText = document.getElementById("status-text");
        statusText.textContent = message;
        statusText.style.color = isError ? "#f5576c" : "#8b92b0";
      }

      function generateMockData(count = 10) {
        const mockUsers = [];

        // Define specific sea zones to avoid land
        const seaZones = [
          // North of Alexandria (deeper waters)
          {
            lat: { min: 31.4, max: 31.8 },
            lon: { min: 29.6, max: 30.2 },
          },
          // Northwest of Alexandria
          {
            lat: { min: 31.3, max: 31.7 },
            lon: { min: 29.2, max: 29.8 },
          },
          // Northeast of Alexandria
          {
            lat: { min: 31.4, max: 31.9 },
            lon: { min: 30.1, max: 30.5 },
          },
        ];

        for (let i = 0; i < count; i++) {
          // Randomly select a sea zone
          const zone = seaZones[Math.floor(Math.random() * seaZones.length)];

          // Generate coordinates within the selected zone
          const lat =
            zone.lat.min + Math.random() * (zone.lat.max - zone.lat.min);
          const lon =
            zone.lon.min + Math.random() * (zone.lon.max - zone.lon.min);

          // Random emergency state
          const isEmergency = Math.random() < 0.3; // 30% chance of emergency

          mockUsers.push({
            id: `USER_${String(i + 1).padStart(3, "0")}`,
            lat: parseFloat(lat.toFixed(5)),
            lon: parseFloat(lon.toFixed(5)),
            heart_rate: isEmergency
              ? Math.floor(Math.random() * 40) + 120
              : Math.floor(Math.random() * 30) + 60,
            spo2: isEmergency
              ? Math.floor(Math.random() * 10) + 75
              : Math.floor(Math.random() * 5) + 95,
            humidity: isEmergency
              ? Math.floor(Math.random() * 20) + 75
              : Math.floor(Math.random() * 30) + 40,
            state: isEmergency ? 1 : 0,
            last_packet_s: Math.floor(Math.random() * 55) + 5,
          });
        }

        return mockUsers;
      }

      document
        .getElementById("btn-load-users")
        .addEventListener("click", async () => {
          const loadingSpinner = document.getElementById("loading-users");
          loadingSpinner.style.display = "block";
          setStatus("Generating mock data...");

          try {
            // Generate mock data instead of loading from file
            const mockUsers = generateMockData(10);

            setStatus("Sending to API for priority prediction...");

            const apiResponse = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(mockUsers),
            });

            if (!apiResponse.ok) {
              throw new Error(`API error: ${apiResponse.status}`);
            }

            const predictions = await apiResponse.json();

            // Clear existing markers
            Object.values(markers).forEach((marker) => map.removeLayer(marker));
            markers = {};
            victimsData = [];

            predictions.forEach((victim) => {
              const distance = haversineDistance(
                RESCUE_CENTER.lat,
                RESCUE_CENTER.lon,
                victim.lat,
                victim.lon
              );

              victim.distance_km = distance;
              victim.eta_min = calculateETA(distance);
              victimsData.push(victim);

              const marker = createMarker(victim);
              markers[victim.id] = marker;
              marker.addTo(map);
            });

            updateStats();
            updateTable();
            setStatus(
              `Successfully loaded ${victimsData.length} users with priority predictions`
            );
          } catch (error) {
            console.error("Error:", error);
            setStatus(`Error: ${error.message}`, true);
          } finally {
            loadingSpinner.style.display = "none";
          }
        });

      document
        .getElementById("btn-draw-paths")
        .addEventListener("click", () => {
          rescuePaths.forEach((item) => {
            map.removeLayer(item.path);
            if (item.label) map.removeLayer(item.label);
          });
          rescuePaths = [];

          if (victimsData.length === 0) {
            setStatus('No users loaded. Click "Load Users" first.', true);
            return;
          }

          const count = parseInt(document.getElementById("victim-count").value);
          const sortedVictims = [...victimsData].sort(
            (a, b) => b.priority_score - a.priority_score
          );
          const topVictims = sortedVictims.slice(0, count);

          const colors = [
            "#ff3b5c",
            "#ff6b35",
            "#ffa726",
            "#ffca28",
            "#66bb6a",
          ];

          topVictims.forEach((victim, index) => {
            const color = colors[index % colors.length];

            const path = L.polyline(
              [
                [RESCUE_CENTER.lat, RESCUE_CENTER.lon],
                [victim.lat, victim.lon],
              ],
              {
                color: color,
                weight: 4,
                opacity: 0.7,
                dashArray: "10, 10",
              }
            ).addTo(map);

            const midLat = (RESCUE_CENTER.lat + victim.lat) / 2;
            const midLon = (RESCUE_CENTER.lon + victim.lon) / 2;

            const label = L.marker([midLat, midLon], {
              icon: L.divIcon({
                className: "",
                html: `<div class="path-label">#${
                  index + 1
                }: ${victim.distance_km.toFixed(1)} km | ETA: ${
                  victim.eta_min
                } min</div>`,
                iconSize: [150, 30],
                iconAnchor: [75, 15],
              }),
            }).addTo(map);

            rescuePaths.push({ path, label });
          });

          setStatus(
            `Drew rescue paths for top ${topVictims.length} priority victims`
          );
        });

      document.getElementById("btn-clear").addEventListener("click", () => {
        Object.values(markers).forEach((marker) => map.removeLayer(marker));
        markers = {};

        rescuePaths.forEach((item) => {
          map.removeLayer(item.path);
          if (item.label) map.removeLayer(item.label);
        });
        rescuePaths = [];

        victimsData = [];

        document.getElementById("victims-tbody").innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; color: #8b92b0; padding: 40px;">
                        <i class="fas fa-info-circle" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
                        No users loaded. Click "Load Users" to start.
                    </td>
                </tr>
            `;

        updateStats();
        setStatus("Cleared all data. Ready to load users.");
      });

      setStatus("Ready to load users");
    </script>
  </body>
</html>
