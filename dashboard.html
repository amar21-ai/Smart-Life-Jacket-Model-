<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Smart Life Jacket — AI Priority Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <style>
      :root {
        --bg: #0a1628;
        --card: #111c44;
        --text: #ffffff;
        --muted: #7681a4;
        --accent: #4318ff;
        --danger: #ff3b3b;
        --success: #05cd99;
        --warning: #ffb547;
      }

      body {
        background: var(--bg);
        color: var(--text);
        font-family: "Plus Jakarta Display", sans-serif;
        padding: 20px;
      }

      .dashboard-card {
        background: var(--card);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        height: 100%;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: linear-gradient(45deg, #1a2b58, #111c44);
        border-radius: 15px;
        padding: 15px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 700;
        margin: 10px 0;
      }

      .stat-label {
        color: var(--muted);
        font-size: 14px;
      }

      #map {
        height: 600px;
        border-radius: 20px;
        margin-bottom: 20px;
      }

      .priority-badge {
        padding: 6px 12px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 12px;
      }

      .table-container {
        background: var(--card);
        border-radius: 20px;
        padding: 20px;
        margin-top: 20px;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
      }

      th {
        color: var(--muted);
        font-weight: 600;
        padding: 12px;
        text-align: left;
      }

      td {
        background: rgba(255, 255, 255, 0.02);
        padding: 12px;
      }

      /* pulsing marker (High) */
      .pulse {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #ff3b3b;
        box-shadow: 0 0 8px rgba(255, 59, 59, 0.8);
        position: relative;
      }
      .pulse::after {
        content: "";
        position: absolute;
        left: -6px;
        top: -6px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: rgba(255, 59, 59, 0.15);
        animation: pulse 1.6s infinite;
      }
      @keyframes pulse {
        0% {
          transform: scale(0.8);
          opacity: 0.6;
        }
        70% {
          transform: scale(1.7);
          opacity: 0;
        }
        100% {
          transform: scale(1.7);
          opacity: 0;
        }
      }

      .table-wrap {
        max-height: 520px;
        overflow: auto;
        border-radius: 8px;
      }
      table thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        background: rgba(10, 16, 24, 0.7);
        color: #cfe9ff;
      }
      .small-muted {
        color: var(--muted);
        font-size: 12px;
      }

      .chart-card {
        height: 190px;
      }

      /* responsive tweaks */
      @media (max-width: 900px) {
        #map {
          height: 360px;
        }
        .header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
      }

      .rescue-center-icon {
        width: 24px;
        height: 24px;
        background: #ffffff;
        border: 3px solid #ff3b3b;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 10px rgba(255, 59, 59, 0.5);
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="brand">
        <div
          style="
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: linear-gradient(135deg, #00bcd4, #4f46e5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 20px;
          "
        >
          SJ
        </div>
        <div>
          <h1>Smart Life Jacket — AI Priority</h1>
          <p class="small-muted">
            Live demo • AI ranks rescue priority from jacket sensors
          </p>
        </div>
      </div>
      <div class="controls d-flex align-items-center" style="gap: 8px">
        <div class="d-flex gap-2 align-items-center">
          <button id="btn-show-users" class="btn btn-primary btn-sm">
            <i class="fas fa-users"></i> Show 10 Users
          </button>
          <button id="btn-refresh" class="btn btn-outline-light btn-sm">
            <i class="fa-solid fa-arrows-rotate"></i> Refresh
          </button>
          <select
            id="rescue-count"
            class="form-select form-select-sm ms-2"
            style="width: auto"
          >
            <option value="1">Rescue 1</option>
            <option value="2">Rescue 2</option>
            <option value="3" selected>Rescue 3</option>
            <option value="4">Rescue 4</option>
            <option value="5">Rescue 5</option>
          </select>
          <button id="btn-draw-paths" class="btn btn-success btn-sm">
            <i class="fa-solid fa-route me-1"></i> Draw Rescue Paths
          </button>
        </div>
        <div style="min-width: 220px">
          <input
            id="api-url"
            class="form-control form-control-sm"
            value="http://127.0.0.1:5000/predict"
            title="API url"
          />
          <div class="small-muted">
            API URL (use LAN IP to test from other devices)
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <!-- Stats Row -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Users</div>
          <div class="stat-value" id="total-users">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">High Priority</div>
          <div class="stat-value" id="high-priority">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average Response Time</div>
          <div class="stat-value" id="avg-eta">0 min</div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="row">
        <div class="col-lg-8">
          <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4>Live Rescue Map</h4>
              <div>
                <select id="rescue-count" class="form-select form-select-sm">
                  <option value="3" selected>3 Rescues</option>
                  <option value="5">5 Rescues</option>
                </select>
                <button id="btn-draw-paths" class="btn btn-primary btn-sm ms-2">
                  <i class="fas fa-route"></i> Calculate Routes
                </button>
              </div>
            </div>
            <div id="map"></div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="dashboard-card">
            <h4>Priority Cases</h4>
            <div class="table-responsive">
              <table id="tbl" class="table table-dark">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Priority</th>
                    <th>Vitals</th>
                    <th>ETA</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- libs -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // ---------- Config ----------
      const centerLat = 31.2,
        centerLon = 29.9; // Alexandria port coordinates
      const POLL_INTERVAL = 5000; // ms
      let polling = true;

      // ---------- Map setup ----------
      let map = L.map("map").setView([centerLat, centerLon], 8);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
      }).addTo(map);

      // center marker
      L.circleMarker([centerLat, centerLon], {
        radius: 7,
        color: "#ffffff",
        fillColor: "#334155",
        fillOpacity: 0.9,
      })
        .addTo(map)
        .bindPopup("Rescue center");

      // prominent rescue center marker
      const rescueCenter = L.marker([centerLat, centerLon], {
        icon: L.divIcon({
          className: "rescue-center-icon",
          html: `
            <div style="
                width: 24px;
                height: 24px;
                background: #ffffff;
                border: 3px solid #ff3b3b;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 0 10px rgba(255,59,59,0.5);
            ">
                <i class="fa-solid fa-anchor" style="color:#ff3b3b;font-size:12px;"></i>
            </div>
          `,
          iconSize: [24, 24],
          iconAnchor: [12, 12],
        }),
      })
        .addTo(map)
        .bindPopup("<b>Rescue Center</b><br>Alexandria Port");

      // store markers keyed by id
      const markers = {};

      function makeMarker(v) {
        const cls = v.priority_class;
        const lat = parseFloat(
          v.lat || v.latitude || centerLat + (Math.random() - 0.5) * 0.2
        );
        const lon = parseFloat(
          v.lon || v.longitude || centerLon + (Math.random() - 0.5) * 0.2
        );
        let marker;

        if (cls === "High") {
          // pulsing div icon
          const div = L.divIcon({
            className: "",
            html: '<div class="pulse"></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15],
          });
          marker = L.marker([lat, lon], { icon: div });
        } else {
          const color = cls === "Medium" ? "#ff8a00" : "#12b26d";
          const circle = L.circleMarker([lat, lon], {
            radius: 9,
            color: color,
            fillColor: color,
            fillOpacity: 0.9,
          });
          marker = circle;
        }

        marker.addTo(map);
        return marker;
      }

      function upsertVictim(v) {
        const id = v.id || "victim_" + Math.random().toString(36).slice(2, 8);
        // remove old marker if exists then add new (easier for style updates)
        if (markers[id]) {
          try {
            map.removeLayer(markers[id]);
          } catch (e) {}
        }
        const marker = makeMarker(v);
        marker.bindPopup(
          `<b>${id}</b><br/>Priority: ${v.priority_score} (${v.priority_class})<br/>HR:${v.heart_rate}, SpO₂:${v.spo2}`
        );
        markers[id] = marker;
        updateTableRow(id, v);
      }

      function updateTableRow(id, v) {
        const tbody = document.getElementById("tbody");
        let row = document.getElementById("row-" + id);
        const cls = v.priority_class;
        const badgeClass =
          cls === "High"
            ? "prio-high"
            : cls === "Medium"
            ? "prio-medium"
            : "prio-low";
        const tr = document.createElement("tr");
        tr.id = "row-" + id;
        tr.innerHTML = `
      <td>${id}</td>
      <td>${v.heart_rate}</td>
      <td>${v.spo2}</td>
      <td>${v.humidity}</td>
      <td>${v.state == 1 ? "sinking" : "floating"}</td>
      <td>${v.eta_min}</td>
      <td>${v.priority_score}</td>
      <td><span class="priority-badge ${badgeClass}">${
          v.priority_class
        }</span></td>
    `;
        if (row) tbody.replaceChild(tr, row);
        else tbody.appendChild(tr);
        sortTableByPriority();
      }

      function sortTableByPriority() {
        const tbody = document.getElementById("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        rows.sort(
          (a, b) =>
            parseFloat(b.children[6].textContent) -
            parseFloat(a.children[6].textContent)
        );
        rows.forEach((r) => tbody.appendChild(r));
      }

      // ---------- API calls ----------
      async function postToApi(payload) {
        const api = document.getElementById("api-url").value.trim();
        document.getElementById("status").textContent = "posting...";
        try {
          const resp = await fetch(api, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) {
            const txt = await resp.text();
            document.getElementById("status").textContent = "api error";
            alert("API error: " + txt);
            return;
          }
          const data = await resp.json();
          const arr = Array.isArray(data) ? data : [data];
          arr.forEach(upsertVictim);
          document.getElementById("status").textContent =
            "ok • " + new Date().toLocaleTimeString();
        } catch (e) {
          console.error(e);
          document.getElementById("status").textContent = "network error";
        }
      }

      // ---------- Demo payloads ----------
      let demoUsers = [];

      // Load demo users from JSON when page loads
      async function loadDemoUsers() {
        try {
          const response = await fetch("demo_users.json");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          demoUsers = await response.json();
          console.log(`Loaded ${demoUsers.length} demo users`);
        } catch (e) {
          console.error("Failed to load demo users:", e);
          alert("Failed to load demo_users.json. Please generate it first!");
        }
      }

      // Add event listener for the show users button
      document
        .getElementById("btn-show-users")
        .addEventListener("click", async () => {
          if (demoUsers.length === 0) {
            await loadDemoUsers(); // Try loading if not loaded
          }

          if (demoUsers.length > 0) {
            // Take first 10 users
            const tenUsers = demoUsers.slice(0, 10);

            // Send to API
            try {
              const response = await fetch("http://localhost:5000/predict", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(tenUsers),
              });

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const predictions = await response.json();
              updateMap(predictions); // Update map with new markers
              updateTable(predictions); // Update table with new data
              console.log("Updated map with 10 users");
            } catch (e) {
              console.error("Failed to update users:", e);
              alert(
                "Failed to update users. Check if the API server is running."
              );
            }
          }
        });

      // Load users when page loads
      document.addEventListener("DOMContentLoaded", loadDemoUsers);

      // Store rescue paths
      let rescuePaths = [];

      // Push demo users
      document
        .getElementById("btn-push-demo")
        .addEventListener("click", () => postToApi(demoUsers));

      // Draw rescue paths
      document
        .getElementById("btn-draw-paths")
        .addEventListener("click", () => {
          // Clear existing paths
          rescuePaths.forEach((path) => map.removeLayer(path));
          rescuePaths = [];

          // Get number of paths to draw
          const count = parseInt(document.getElementById("rescue-count").value);

          // Get sorted victims by priority
          const tbody = document.getElementById("tbody");
          const rows = Array.from(tbody.querySelectorAll("tr"));
          const sortedVictims = rows
            .sort(
              (a, b) =>
                parseFloat(b.children[6].textContent) -
                parseFloat(a.children[6].textContent)
            )
            .slice(0, count);

          // Draw paths for top priority victims
          sortedVictims.forEach((row, index) => {
            const id = row.children[0].textContent;
            const marker = markers[id];
            if (!marker) return;

            // Get victim coordinates
            const victimLatLng = marker.getLatLng();

            // Create path with color based on priority
            const colors = [
              "#ff0000",
              "#ff6b00",
              "#ffa500",
              "#ffd700",
              "#ffff00",
            ];
            const path = L.polyline(
              [
                [centerLat, centerLon],
                [victimLatLng.lat, victimLatLng.lng],
              ],
              {
                color: colors[index],
                weight: 4,
                opacity: 0.8,
                dashArray: "10, 10",
                animate: true,
              }
            ).addTo(map);

            // Add distance label
            const midPoint = [
              (centerLat + victimLatLng.lat) / 2,
              (centerLon + victimLatLng.lng) / 2,
            ];
            const distance = (
              map.distance(
                [centerLat, centerLon],
                [victimLatLng.lat, victimLatLng.lng]
              ) / 1000
            ).toFixed(1);
            L.marker(midPoint, {
              icon: L.divIcon({
                className: "distance-label",
                html: `<div style="background:rgba(0,0,0,0.7);color:white;padding:3px 8px;border-radius:4px;font-size:12px">${distance} km</div>`,
              }),
            }).addTo(map);

            rescuePaths.push(path);
          });
        });
      document.getElementById("btn-refresh").addEventListener("click", () => {
        // re-send all current table rows to recalc
        const rows = Array.from(document.querySelectorAll("#tbody tr"));
        if (rows.length === 0) {
          document.getElementById("status").textContent = "no victims";
          return;
        }
        const payload = rows.map((r) => {
          return {
            id: r.children[0].textContent,
            heart_rate: Number(r.children[1].textContent),
            spo2: Number(r.children[2].textContent),
            humidity: Number(r.children[3].textContent),
            state: r.children[4].textContent === "sinking" ? 1 : 0,
            lat: markers[r.children[0].textContent]
              ? markers[r.children[0].textContent].getLatLng().lat
              : centerLat,
            lon: markers[r.children[0].textContent]
              ? markers[r.children[0].textContent].getLatLng().lng
              : centerLon,
            last_packet_s: 5,
          };
        });
        postToApi(payload);
      });

      // auto toggle
      document
        .getElementById("btn-toggle-auto")
        .addEventListener("click", (e) => {
          polling = !polling;
          e.currentTarget.innerHTML = polling
            ? '<i class="fa-solid fa-toggle-on"></i> Auto: ON'
            : '<i class="fa-solid fa-toggle-off"></i> Auto: OFF';
          document.getElementById("status").textContent = polling
            ? "auto on"
            : "auto off";
        });

      document
        .getElementById("filter-all")
        .addEventListener("click", () => filterTable("All"));
      document
        .getElementById("filter-high")
        .addEventListener("click", () => filterTable("High"));
      document
        .getElementById("filter-medium")
        .addEventListener("click", () => filterTable("Medium"));
      document
        .getElementById("filter-low")
        .addEventListener("click", () => filterTable("Low"));

      function filterTable(cls) {
        const rows = Array.from(document.querySelectorAll("#tbody tr"));
        rows.forEach((r) => {
          const c = r.children[7].textContent.trim();
          if (cls === "All") r.style.display = "";
          else r.style.display = c === cls ? "" : "none";
        });
      }

      // sorting headers
      document.querySelectorAll("#tbl thead th[data-sort]").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-sort");
          const rows = Array.from(document.querySelectorAll("#tbody tr"));
          rows.sort((a, b) => {
            let va, vb;
            if (key === "id") {
              va = a.children[0].textContent;
              vb = b.children[0].textContent;
              return va.localeCompare(vb);
            }
            if (key === "heart") {
              va = Number(a.children[1].textContent);
              vb = Number(b.children[1].textContent);
              return vb - va;
            }
            if (key === "spo2") {
              va = Number(a.children[2].textContent);
              vb = Number(b.children[2].textContent);
              return vb - va;
            }
            if (key === "hum") {
              va = Number(a.children[3].textContent);
              vb = Number(b.children[3].textContent);
              return vb - va;
            }
            if (key === "state") {
              va = a.children[4].textContent;
              vb = b.children[4].textContent;
              return va.localeCompare(vb);
            }
            if (key === "eta") {
              va = Number(a.children[5].textContent);
              vb = Number(b.children[5].textContent);
              return vb - va;
            }
            if (key === "score") {
              va = Number(a.children[6].textContent);
              vb = Number(b.children[6].textContent);
              return vb - va;
            }
            return 0;
          });
          rows.forEach((r) => document.getElementById("tbody").appendChild(r));
        });
      });

      // ---------- Auto poll loop ----------
      setInterval(async () => {
        if (!polling) return;
        const rows = Array.from(document.querySelectorAll("#tbody tr"));
        // if empty no-op
        if (rows.length === 0) return;
        // re-send existing victims to refresh predictions (simulate live updates)
        const payload = rows.map((r) => ({
          id: r.children[0].textContent,
          heart_rate: Number(r.children[1].textContent),
          spo2: Number(r.children[2].textContent),
          humidity: Number(r.children[3].textContent),
          state: r.children[4].textContent === "sinking" ? 1 : 0,
          lat: markers[r.children[0].textContent]
            ? markers[r.children[0].textContent].getLatLng().lat
            : centerLat,
          lon: markers[r.children[0].textContent]
            ? markers[r.children[0].textContent].getLatLng().lng
            : centerLon,
          last_packet_s: 5,
        }));
        if (payload.length > 0) await postToApi(payload);
      }, POLL_INTERVAL);

      // ---------- Feature importance chart (static values from training) ----------
      // If you want, replace these values by the actual model.importances_ printed earlier.
      const featureLabels = [
        "heart_rate",
        "spo2",
        "humidity",
        "state",
        "eta_min",
        "distance_km",
        "last_packet_s",
      ];
      const featureValues = [0.25, 0.175, 0.14, 0.102, 0.124, 0.11, 0.1]; // example from training output
      const ctx = document.getElementById("featChart").getContext("2d");
      const featChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: featureLabels,
          datasets: [
            {
              label: "Feature importance",
              data: featureValues,
              backgroundColor: [
                "#1f6feb",
                "#4f46e5",
                "#00bcd4",
                "#7c3aed",
                "#ff8a00",
                "#12b26d",
                "#9ca3af",
              ],
            },
          ],
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, max: 0.35 } },
          maintainAspectRatio: false,
        },
      });

      // init with no victims
      document.getElementById("status").textContent = "ready";

      function updateStats() {
        const rows = Array.from(document.querySelectorAll("#tbody tr"));
        document.getElementById("total-users").textContent = rows.length;

        const highPriority = rows.filter(
          (r) => r.querySelector(".priority-badge").textContent === "High"
        ).length;
        document.getElementById("high-priority").textContent = highPriority;

        const etas = rows.map((r) => parseFloat(r.children[3].textContent));
        const avgEta = etas.length
          ? Math.round(etas.reduce((a, b) => a + b) / etas.length)
          : 0;
        document.getElementById("avg-eta").textContent = `${avgEta} min`;
      }
    </script>
  </body>
</html>
